name: Deploy to GitHub Pages (versioned)

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare site for versioned deploy
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name || github.ref_name }}"
          echo "Raw tag: $TAG"

          TAG="${TAG#refs/tags/}"
          TAG_LOWER=$(echo "$TAG" | tr '[:upper:]' '[:lower:]')
          BASE="${TAG_LOWER#v}"

          echo "Normalized tag: $BASE"
          DEST="_site/v${BASE}"
          echo "→ Папка деплоя: $DEST"

          mkdir -p "$DEST"
          cp -r index.html ru en "$DEST/"

          rm -rf _site/latest
          mkdir -p _site/latest
          cp -r index.html ru en _site/latest/

          echo "Содержимое _site:"
          find _site -maxdepth 2 -type d -print

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          keep_files: true
